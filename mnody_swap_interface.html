<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MNODY Swap - Polygon</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #1a1b3d 0%, #0a0b1e 100%);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  padding: 20px;
}

.swap-container {
  background: rgba(30, 31, 60, 0.95);
  border-radius: 24px;
  padding: 24px;
  width: 100%;
  max-width: 480px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.logo-section {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-section h2 {
  font-size: 24px;
  font-weight: 600;
}

.polygon-badge {
  background: linear-gradient(135deg, #8247e5, #6b21a8);
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
}

.header-actions {
  display: flex;
  gap: 8px;
}

.icon-btn {
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: #fff;
  width: 40px;
  height: 40px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.icon-btn:hover {
  background: rgba(255, 255, 255, 0.15);
}

.settings-modal, .history-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.settings-modal.show, .history-modal.show {
  display: flex;
}

.modal-content {
  background: rgba(30, 31, 60, 0.98);
  border-radius: 20px;
  padding: 24px;
  width: 90%;
  max-width: 400px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-header h3 {
  font-size: 20px;
}

.close-btn {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 24px;
  cursor: pointer;
}

.setting-row {
  margin: 16px 0;
}

.setting-label {
  font-size: 14px;
  color: #8f8f9f;
  margin-bottom: 8px;
}

.setting-input {
  width: 100%;
  background: rgba(20, 21, 45, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 12px;
  color: #fff;
  font-size: 16px;
}

.contract-info {
  background: rgba(40, 160, 240, 0.1);
  border: 1px solid rgba(40, 160, 240, 0.3);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 16px;
  font-size: 11px;
  text-align: center;
}

.contract-info a {
  color: #28a0f0;
  text-decoration: none;
  word-break: break-all;
}

.price-info {
  background: rgba(255, 107, 157, 0.1);
  border: 1px solid rgba(255, 107, 157, 0.3);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.price-left {
  font-size: 12px;
  color: #8f8f9f;
}

.price-right {
  font-size: 16px;
  font-weight: 600;
  color: #ff6b9d;
}

.swap-box {
  background: rgba(20, 21, 45, 0.8);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 8px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.swap-label {
  font-size: 13px;
  color: #8f8f9f;
  margin-bottom: 12px;
  font-weight: 500;
}

.token-select {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid rgba(255, 255, 255, 0.08);
}

.token-select:hover {
  background: rgba(255, 255, 255, 0.08);
}

.token-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ff6b9d, #feca57);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 14px;
}

.token-info {
  flex: 1;
}

.token-name {
  font-size: 16px;
  font-weight: 600;
  color: #fff;
}

.token-chain {
  font-size: 12px;
  color: #8f8f9f;
}

.amount-input {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 28px;
  font-weight: 600;
  width: 100%;
  margin-top: 12px;
  outline: none;
}

.amount-input::placeholder {
  color: rgba(255, 255, 255, 0.3);
}

.balance {
  font-size: 13px;
  color: #8f8f9f;
  margin-top: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.balance-left {
  color: #8f8f9f;
}

.balance-right {
  display: flex;
  gap: 8px;
}

.balance-btn {
  background: rgba(255, 107, 157, 0.15);
  border: 1px solid rgba(255, 107, 157, 0.3);
  color: #ff6b9d;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
}

.balance-btn:hover {
  background: rgba(255, 107, 157, 0.25);
}

.swap-arrow {
  display: flex;
  justify-content: center;
  margin: -8px 0;
  position: relative;
  z-index: 2;
}

.swap-arrow-btn {
  background: rgba(30, 31, 60, 0.95);
  border: 4px solid rgba(20, 21, 45, 0.8);
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  color: #fff;
  font-size: 20px;
}

.swap-arrow-btn:hover {
  transform: rotate(180deg);
  background: rgba(255, 107, 157, 0.2);
}

.swap-details {
  background: rgba(20, 21, 45, 0.5);
  border-radius: 12px;
  padding: 16px;
  margin: 16px 0;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  margin: 8px 0;
  font-size: 14px;
}

.detail-label {
  color: #8f8f9f;
}

.detail-value {
  color: #fff;
  font-weight: 500;
}

.swap-btn {
  width: 100%;
  padding: 18px;
  background: linear-gradient(135deg, #ff6b9d, #ff9a56);
  border: none;
  border-radius: 16px;
  color: #fff;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 16px;
}

.swap-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(255, 107, 157, 0.5);
}

.swap-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.connect-btn {
  background: linear-gradient(135deg, #00f5a0, #059669);
  color: #000;
}

.status {
  text-align: center;
  margin-top: 16px;
  padding: 12px;
  border-radius: 12px;
  font-size: 14px;
  display: none;
}

.status.success {
  background: rgba(34, 197, 94, 0.15);
  border: 1px solid #22c55e;
  color: #22c55e;
  display: block;
}

.status.error {
  background: rgba(239, 68, 68, 0.15);
  border: 1px solid #ef4444;
  color: #ef4444;
  display: block;
}

.status.pending {
  background: rgba(251, 191, 36, 0.15);
  border: 1px solid #fbbf24;
  color: #fbbf24;
  display: block;
}

.active-tx {
  background: rgba(139, 92, 246, 0.15);
  border: 1px solid #8b5cf6;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 16px;
  display: none;
}

.active-tx.show {
  display: block;
}

.tx-status {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #c4b5fd;
  font-size: 14px;
}

.spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: #8b5cf6;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.history-item {
  background: rgba(20, 21, 45, 0.5);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 12px;
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.history-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.history-type {
  font-weight: 600;
  color: #22c55e;
}

.history-time {
  font-size: 11px;
  color: #8f8f9f;
}

.history-details {
  font-size: 13px;
  color: #fff;
  margin: 4px 0;
}

.history-link {
  font-size: 11px;
  margin-top: 8px;
}

.history-link a {
  color: #28a0f0;
  text-decoration: none;
}

.no-history {
  text-align: center;
  color: #8f8f9f;
  padding: 40px 20px;
}

.quick-amounts {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.quick-btn {
  flex: 1;
  background: rgba(130, 71, 229, 0.15);
  border: 1px solid rgba(130, 71, 229, 0.3);
  color: #8247e5;
  padding: 8px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.quick-btn:hover {
  background: rgba(130, 71, 229, 0.25);
}

.refresh-btn {
  background: rgba(34, 197, 94, 0.15);
  border: 1px solid rgba(34, 197, 94, 0.3);
  color: #22c55e;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
}

.refresh-btn:hover {
  background: rgba(34, 197, 94, 0.25);
}
</style>
</head>
<body>

<div class="swap-container">
  <div class="header">
    <div class="logo-section">
      <h2>MNODY Swap</h2>
      <span class="polygon-badge">ðŸŸ£ Polygon</span>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="openHistory()" title="Transaction History">ðŸ“œ</button>
      <button class="icon-btn" onclick="openSettings()" title="Settings">âš™</button>
    </div>
  </div>

  <div class="contract-info">
    <strong>MNODY Contract:</strong>
    <a href="https://polygonscan.com/address/0x0bacbf5c435c3b0546f7cdf66f960770c7ad912c" target="_blank">
      0x0bacbf5c435c3b0546f7cdf66f960770c7ad912c
    </a>
  </div>

  <div class="contract-info" style="background: rgba(130, 71, 229, 0.1); border-color: rgba(130, 71, 229, 0.3);">
    <strong>ðŸ“Š LP Pool:</strong>
    <a href="https://polygonscan.com/address/0x3cEC491A74c924aaeb74DDe821653AaFEc7b94B9" target="_blank" style="color: #8247e5;">
      QuickSwap MNODY/USDT
    </a>
    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(130, 71, 229, 0.2);">
      <strong>ðŸ”µ Arbitrum Swap:</strong>
      <a href="https://app.camelot.exchange/?token1=0x608B84947d77310836cAa65024F1E164d9Ba8bc7&token2=0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9" target="_blank" style="color: #28a0f0;">
        Trade on Camelot DEX
      </a>
    </div>
  </div>

  <div class="price-info">
    <div class="price-left">
      <div>Current MNODY Price</div>
      <button class="refresh-btn" onclick="refreshPrice()">â†» Refresh</button>
    </div>
    <div class="price-right" id="currentPrice">$0.000000</div>
  </div>

  <div class="active-tx" id="activeTx">
    <div class="tx-status">
      <div class="spinner"></div>
      <span>Processing transaction...</span>
    </div>
  </div>

  <div class="swap-box">
    <div class="swap-label">From</div>
    <div class="token-select">
      <div class="token-icon" id="fromIcon">M</div>
      <div class="token-info">
        <div class="token-name" id="fromToken">MNODY</div>
        <div class="token-chain">Polygon</div>
      </div>
    </div>
    <input type="number" class="amount-input" id="fromAmount" placeholder="0" step="any">
    <div class="balance">
      <span class="balance-left">Balance: <span id="fromBalance">0</span></span>
      <div class="balance-right">
        <button class="balance-btn" onclick="setAmount(25)">25%</button>
        <button class="balance-btn" onclick="setAmount(50)">50%</button>
        <button class="balance-btn" onclick="setAmount(75)">75%</button>
        <button class="balance-btn" onclick="setAmount(100)">MAX</button>
      </div>
    </div>
    <div class="quick-amounts">
      <button class="quick-btn" onclick="setQuickAmount(1000000)">1M</button>
      <button class="quick-btn" onclick="setQuickAmount(5000000)">5M</button>
      <button class="quick-btn" onclick="setQuickAmount(10000000)">10M</button>
      <button class="quick-btn" onclick="setQuickAmount(15000000)">15M</button>
    </div>
  </div>

  <div class="swap-arrow">
    <div class="swap-arrow-btn" onclick="reverseSwap()">â†“</div>
  </div>

  <div class="swap-box">
    <div class="swap-label">To (Estimated)</div>
    <div class="token-select">
      <div class="token-icon" id="toIcon" style="background: linear-gradient(135deg, #26a17b, #22c55e);">U</div>
      <div class="token-info">
        <div class="token-name" id="toToken">USDT</div>
        <div class="token-chain">Polygon</div>
      </div>
    </div>
    <input type="number" class="amount-input" id="toAmount" placeholder="0" readonly>
    <div class="balance">
      <span class="balance-left">Balance: <span id="toBalance">0</span></span>
    </div>
  </div>

  <div class="swap-details" id="swapDetails" style="display: none;">
    <div class="detail-row">
      <span class="detail-label">Exchange Rate</span>
      <span class="detail-value" id="rate">1 MNODY = 0.00 USDT</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Price Impact</span>
      <span class="detail-value" id="priceImpact">< 0.01%</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Minimum Received</span>
      <span class="detail-value" id="minReceived">0.00</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Slippage Tolerance</span>
      <span class="detail-value" id="slippageDisplay">0.5%</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">Network Fee</span>
      <span class="detail-value">~$0.01 - $0.05</span>
    </div>
  </div>

  <button class="swap-btn connect-btn" id="swapBtn" onclick="handleSwap()">Connect Wallet</button>

  <div class="status" id="statusMsg"></div>
</div>

<!-- Settings Modal -->
<div class="settings-modal" id="settingsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Settings</h3>
      <button class="close-btn" onclick="closeSettings()">Ã—</button>
    </div>
    <div class="setting-row">
      <div class="setting-label">Slippage Tolerance (%)</div>
      <input type="number" class="setting-input" id="slippageInput" value="0.5" step="0.1" min="0.1" max="50">
      <div style="font-size: 11px; color: #8f8f9f; margin-top: 4px;">
        Higher slippage = less chance of failure, but worse price
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">Transaction Deadline (minutes)</div>
      <input type="number" class="setting-input" id="deadlineInput" value="20" step="1" min="1" max="60">
      <div style="font-size: 11px; color: #8f8f9f; margin-top: 4px;">
        Transaction will revert if pending for longer than this
      </div>
    </div>
    <div class="setting-row">
      <div class="setting-label">Gas Price (Optional)</div>
      <select class="setting-input" id="gasSpeed">
        <option value="standard">Standard</option>
        <option value="fast">Fast</option>
        <option value="instant">Instant</option>
      </select>
    </div>
  </div>
</div>

<!-- History Modal -->
<div class="history-modal" id="historyModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Transaction History</h3>
      <button class="close-btn" onclick="closeHistory()">Ã—</button>
    </div>
    <div id="historyList"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
const POLYGON = {
  chainId: '0x89',
  name: 'Polygon',
  rpc: 'https://polygon-rpc.com',
  explorer: 'https://polygonscan.com',
  mnody: '0x0bacbf5c435c3b0546f7cdf66f960770c7ad912c',
  usdt: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F',
  router: '0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff',
  pair: '0x3cEC491A74c924aaeb74DDe821653AaFEc7b94B9'
};

let provider, signer, account;
let swapDirection = 'mnodyToUsdt';
let slippageTolerance = 0.5;
let deadlineMinutes = 20;
let gasSpeed = 'standard';
let swapHistory = [];

const PAIR_ABI = [
  "function getReserves() view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)",
  "function token0() view returns (address)",
  "function token1() view returns (address)"
];

const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function approve(address spender, uint256 amount) returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function decimals() view returns (uint8)"
];

const ROUTER_ABI = [
  "function getAmountsOut(uint amountIn, address[] memory path) view returns (uint[] memory amounts)",
  "function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) returns (uint[] memory amounts)"
];

// Load history from localStorage
function loadHistory() {
  const saved = localStorage.getItem('mnody_swap_history');
  if (saved) {
    swapHistory = JSON.parse(saved);
  }
}

function saveHistory() {
  localStorage.setItem('mnody_swap_history', JSON.stringify(swapHistory));
}

function openSettings() {
  document.getElementById('settingsModal').classList.add('show');
  document.getElementById('slippageInput').value = slippageTolerance;
  document.getElementById('deadlineInput').value = deadlineMinutes;
  document.getElementById('gasSpeed').value = gasSpeed;
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('show');
  slippageTolerance = parseFloat(document.getElementById('slippageInput').value);
  deadlineMinutes = parseInt(document.getElementById('deadlineInput').value);
  gasSpeed = document.getElementById('gasSpeed').value;
  document.getElementById('slippageDisplay').textContent = slippageTolerance + '%';
  
  const fromAmount = document.getElementById('fromAmount').value;
  if (fromAmount && parseFloat(fromAmount) > 0 && account) {
    getQuote(fromAmount);
  }
}

function openHistory() {
  loadHistory();
  const historyList = document.getElementById('historyList');
  
  if (swapHistory.length === 0) {
    historyList.innerHTML = '<div class="no-history">No transactions yet</div>';
  } else {
    historyList.innerHTML = swapHistory.map(item => `
      <div class="history-item">
        <div class="history-header">
          <span class="history-type">${item.type}</span>
          <span class="history-time">${item.time}</span>
        </div>
        <div class="history-details">
          ${item.fromAmount} ${item.fromToken} â†’ ${item.toAmount} ${item.toToken}
        </div>
        <div class="history-link">
          <a href="${POLYGON.explorer}/tx/${item.hash}" target="_blank">
            View on PolygonScan â†—
          </a>
        </div>
      </div>
    `).join('');
  }
  
  document.getElementById('historyModal').classList.add('show');
}

function closeHistory() {
  document.getElementById('historyModal').classList.remove('show');
}

async function connectWallet() {
  if (!window.ethereum) {
    showStatus('Please install MetaMask', 'error');
    return false;
  }

  try {
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: POLYGON.chainId }]
    });
  } catch (e) {
    if (e.code === 4902) {
      await window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [{
          chainId: POLYGON.chainId,
          chainName: POLYGON.name,
          rpcUrls: [POLYGON.rpc],
          nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
          blockExplorerUrls: [POLYGON.explorer]
        }]
      });
    }
  }

  provider = new ethers.providers.Web3Provider(window.ethereum);
  const accounts = await provider.send("eth_requestAccounts", []);
  account = accounts[0];
  signer = provider.getSigner();

  document.getElementById('swapBtn').textContent = 'Enter Amount';
  document.getElementById('swapBtn').classList.remove('connect-btn');
  
  await updateBalances();
  await refreshPrice();
  return true;
}

async function updateBalances() {
  if (!account) return;
  
  try {
    const mnodyContract = new ethers.Contract(POLYGON.mnody, ERC20_ABI, provider);
    const usdtContract = new ethers.Contract(POLYGON.usdt, ERC20_ABI, provider);

    const mnodyBal = await mnodyContract.balanceOf(account);
    const usdtBal = await usdtContract.balanceOf(account);

    const mnodyFormatted = parseFloat(ethers.utils.formatEther(mnodyBal)).toFixed(2);
    const usdtFormatted = parseFloat(ethers.utils.formatUnits(usdtBal, 6)).toFixed(2);

    if (swapDirection === 'mnodyToUsdt') {
      document.getElementById('fromBalance').textContent = mnodyFormatted + ' MNODY';
      document.getElementById('toBalance').textContent = usdtFormatted + ' USDT';
    } else {
      document.getElementById('fromBalance').textContent = usdtFormatted + ' USDT';
      document.getElementById('toBalance').textContent = mnodyFormatted + ' MNODY';
    }
  } catch (e) {
    console.error('Balance fetch error:', e);
  }
}

async function refreshPrice() {
  if (!provider) {
    provider = new ethers.providers.JsonRpcProvider(POLYGON.rpc);
  }
  
  try {
    const pairContract = new ethers.Contract(POLYGON.pair, PAIR_ABI, provider);
    const reserves = await pairContract.getReserves();
    const token0 = await pairContract.token0();
    
    let mnodyReserve, usdtReserve;
    
    // Check which token is token0
    if (token0.toLowerCase() === POLYGON.mnody.toLowerCase()) {
      mnodyReserve = reserves[0];
      usdtReserve = reserves[1];
    } else {
      mnodyReserve = reserves[1];
      usdtReserve = reserves[0];
}
// Calculate price: USDT reserve / MNODY reserve
const mnodyReserveFormatted = parseFloat(ethers.utils.formatEther(mnodyReserve));
const usdtReserveFormatted = parseFloat(ethers.utils.formatUnits(usdtReserve, 6));

const price = usdtReserveFormatted / mnodyReserveFormatted;
document.getElementById('currentPrice').textContent = '$' + price.toFixed(8);
} catch (e) {
console.error('Price fetch error:', e);
document.getElementById('currentPrice').textContent = '$0.000000';
}
}
function setAmount(percentage) {
if (!account) {
showStatus('Please connect wallet first', 'error');
return;
}
const balanceText = document.getElementById('fromBalance').textContent;
const balanceValue = parseFloat(balanceText.split(' ')[0]);
if (balanceValue > 0) {
const amount = (balanceValue * percentage / 100).toFixed(2);
document.getElementById('fromAmount').value = amount;
getQuote(amount);
}
}
function setQuickAmount(amount) {
document.getElementById('fromAmount').value = amount;
if (account) {
getQuote(amount);
}
}
async function getQuote(amountIn) {
if (!amountIn || amountIn <= 0) return;
if (!provider) {
provider = new ethers.providers.JsonRpcProvider(POLYGON.rpc);
}
try {
const router = new ethers.Contract(POLYGON.router, ROUTER_ABI, provider);
const A = swapDirection === 'mnodyToUsdt' ? POLYGON.mnody : POLYGON.usdt;
const B = swapDirection === 'mnodyToUsdt' ? POLYGON.usdt : POLYGON.mnody;
const path = [A, B];

const decimalsIn = swapDirection === 'mnodyToUsdt' ? 18 : 6;
const decimalsOut = swapDirection === 'mnodyToUsdt' ? 6 : 18;

const amountInWei = ethers.utils.parseUnits(amountIn.toString(), decimalsIn);
const amounts = await router.getAmountsOut(amountInWei, path);
const amountOut = ethers.utils.formatUnits(amounts[1], decimalsOut);

const formattedOut = parseFloat(amountOut).toFixed(decimalsOut === 6 ? 6 : 2);
document.getElementById('toAmount').value = formattedOut;

if (swapDirection === 'mnodyToUsdt') {
  document.getElementById('rate').textContent = `1 MNODY = ${(parseFloat(amountOut) / amountIn).toFixed(8)} USDT`;
} else {
  document.getElementById('rate').textContent = `1 USDT = ${(parseFloat(amountOut) / amountIn).toFixed(2)} MNODY`;
}

const minReceived = (parseFloat(amountOut) * (1 - slippageTolerance / 100)).toFixed(decimalsOut === 6 ? 6 : 2);
document.getElementById('minReceived').textContent = minReceived + (swapDirection === 'mnodyToUsdt' ? ' USDT' : ' MNODY');

document.getElementById('swapDetails').style.display = 'block';
document.getElementById('swapBtn').textContent = 'Swap';
document.getElementById('swapBtn').disabled = false;
} catch (e) {
console.error('Quote error:', e);
document.getElementById('toAmount').value = '0';
showStatus('Unable to get quote. Check liquidity.', 'error');
}
}
document.getElementById('fromAmount').addEventListener('input', (e) => {
const val = e.target.value;
if (val && parseFloat(val) > 0) {
getQuote(val);
} else {
document.getElementById('toAmount').value = '';
document.getElementById('swapDetails').style.display = 'none';
}
});
function reverseSwap() {
swapDirection = swapDirection === 'mnodyToUsdt' ? 'usdtToMnody' : 'mnodyToUsdt';
if (swapDirection === 'mnodyToUsdt') {
document.getElementById('fromToken').textContent = 'MNODY';
document.getElementById('toToken').textContent = 'USDT';
document.getElementById('fromIcon').textContent = 'M';
document.getElementById('fromIcon').style.background = 'linear-gradient(135deg, #ff6b9d, #feca57)';
document.getElementById('toIcon').textContent = 'U';
document.getElementById('toIcon').style.background = 'linear-gradient(135deg, #26a17b, #22c55e)';
} else {
document.getElementById('fromToken').textContent = 'USDT';
document.getElementById('toToken').textContent = 'MNODY';
document.getElementById('fromIcon').textContent = 'U';
document.getElementById('fromIcon').style.background = 'linear-gradient(135deg, #26a17b, #22c55e)';
document.getElementById('toIcon').textContent = 'M';
document.getElementById('toIcon').style.background = 'linear-gradient(135deg, #ff6b9d, #feca57)';
}
document.getElementById('fromAmount').value = '';
document.getElementById('toAmount').value = '';
document.getElementById('swapDetails').style.display = 'none';
if (account) {
updateBalances();
}
}
async function handleSwap() {
const btn = document.getElementById('swapBtn');
if (btn.textContent === 'Connect Wallet') {
await connectWallet();
return;
}
const amountIn = document.getElementById('fromAmount').value;
if (!amountIn || parseFloat(amountIn) <= 0) {
showStatus('Please enter an amount', 'error');
return;
}
try {
showActiveTx();
showStatus('Checking allowance...', 'pending');
const tokenIn = swapDirection === 'mnodyToUsdt' ? POLYGON.mnody : POLYGON.usdt;
const decimalsIn = swapDirection === 'mnodyToUsdt' ? 18 : 6;
const amountInWei = ethers.utils.parseUnits(amountIn, decimalsIn);

const tokenContract = new ethers.Contract(tokenIn, ERC20_ABI, signer);
const allowance = await tokenContract.allowance(account, POLYGON.router);

if (allowance.lt(amountInWei)) {
  showStatus('Please approve token spending...', 'pending');
  const approveTx = await tokenContract.approve(POLYGON.router, ethers.constants.MaxUint256);
  showStatus('Approving... Please wait', 'pending');
  await approveTx.wait();
}

showStatus('Executing swap...', 'pending');

const router = new ethers.Contract(POLYGON.router, ROUTER_ABI, signer);
const A = swapDirection === 'mnodyToUsdt' ? POLYGON.mnody : POLYGON.usdt;
const B = swapDirection === 'mnodyToUsdt' ? POLYGON.usdt : POLYGON.mnody;
const path = [A, B];

const amountOut = document.getElementById('toAmount').value;
const decimalsOut = swapDirection === 'mnodyToUsdt' ? 6 : 18;
const slippageMultiplier = 1 - (slippageTolerance / 100);
const amountOutMin = ethers.utils.parseUnits(
  (parseFloat(amountOut) * slippageMultiplier).toFixed(decimalsOut), 
  decimalsOut
);

const deadline = Math.floor(Date.now() / 1000) + 60 * deadlineMinutes;

let gasLimit = 300000;
if (gasSpeed === 'fast') gasLimit = 350000;
if (gasSpeed === 'instant') gasLimit = 400000;

const tx = await router.swapExactTokensForTokens(
  amountInWei,
  amountOutMin,
  path,
  account,
  deadline,
  { gasLimit }
);

showStatus('Transaction sent! Waiting for confirmation...', 'pending');
const receipt = await tx.wait();

hideActiveTx();
showStatus(`âœ… Swap successful! <a href="${POLYGON.explorer}/tx/${receipt.transactionHash}" target="_blank" style="color:#00d9f5;text-decoration:underline">View Transaction</a>`, 'success');

// Add to history
const historyItem = {
  type: swapDirection === 'mnodyToUsdt' ? 'MNODY â†’ USDT' : 'USDT â†’ MNODY',
  fromAmount: amountIn,
  fromToken: swapDirection === 'mnodyToUsdt' ? 'MNODY' : 'USDT',
  toAmount: amountOut,
  toToken: swapDirection === 'mnodyToUsdt' ? 'USDT' : 'MNODY',
  hash: receipt.transactionHash,
  time: new Date().toLocaleString()
};
swapHistory.unshift(historyItem);
if (swapHistory.length > 10) swapHistory.pop();
saveHistory();

document.getElementById('fromAmount').value = '';
document.getElementById('toAmount').value = '';
document.getElementById('swapDetails').style.display = 'none';

await updateBalances();
await refreshPrice();
} catch (e) {
console.error('Swap error:', e);
hideActiveTx();
if (e.code === 4001) {
  showStatus('Transaction rejected by user', 'error');
} else {
  showStatus('Swap failed: ' + (e.reason || e.message), 'error');
}
}
}
function showStatus(msg, type) {
const status = document.getElementById('statusMsg');
status.innerHTML = msg;
status.className = 'status ' + type;
}
function showActiveTx() {
document.getElementById('activeTx').classList.add('show');
}
function hideActiveTx() {
setTimeout(() => {
document.getElementById('activeTx').classList.remove('show');
}, 2000);
}
// Auto-refresh price every 30 seconds
setInterval(() => {
if (provider) {
refreshPrice();
}
}, 30000);
// Initialize
loadHistory();
if (window.ethereum) {
window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
if (accounts.length > 0) {
connectWallet();
} else {
refreshPrice();
}
});
} else {
refreshPrice();
}
</script>
</body>
</html>
```
